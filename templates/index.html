<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keyword Scanner App</title>
    <!-- Links to external stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600&family=Open+Sans:wght@300;400;600&display=swap"
        rel="stylesheet" />
</head>

<body>
    <div class="banner">keyword scanner</div>
    <div class="container">
        <div class="introduction">
            <h2>Hello!</h2>
            <p>
                This app scans documents for the "DEI terms" listed in the 2024 report
                <i>"DEI: Division. Extremism. Ideology: How the Biden-Harris NSF Politicized Science"</i> by the
                U.S. Senate Committee on Commerce, Science, and Transportation.
            </p>
            <p>
                Simply drag and drop your files or click to select them, then click the
                <strong>Scan</strong> button to get started.
            </p>
            <details>
                <summary><strong>But, before you begin, here are three must-know things about the app (click to expand):</strong>
                </summary>
                <ol>
                    <li>
                        It only detects the exact terms listed in the Appendix B of the report and does not consider the context in which
                        words and phrases are used. Detailed information about what the app does (and doesnâ€™t do) is available in its
                        <a href="https://github.com/yourusername/yourrepo" target="_blank">GitHub repository</a>.
                    </li>
                    <li>
                        It supports TXT, DOCX, CSV, XLS/XLSX,and searchable PDF files, and works best with small documents and file sizes (a few pages and MBs). 
                        Scanned PDFs and image files are not supported. Processing large files may take longer or cause the app to crash.
                    </li>
                    </li>
                        It runs on a free-tier plan of the hosting server and was not built for mass or commercial use. Because of that, it may
                        be slow, go offline after a few minutes of inactivity, or stop working if usage limits are reached.
                        You are more than welcome to fork its
                        <a href="https://github.com/yourusername/yourrepo" target="_blank">GitHub repository</a>
                        to create your own app or help out to improve this one!
                    </li>
                </ol>
            </details>
        </div>
        <div class="upload-results-container">
            <!-- File Upload Section -->
            <h3>UPLOAD FILES</h3>
            <form action="/" method="post" enctype="multipart/form-data" id="upload-form">
                <label for="file-upload" class="upload-area" id="drop-area">
                    <p>Drag & Drop files here or click to select</p>
                    <input type="file" id="file-upload" name="files[]" multiple required />
                </label>
                <ul id="file-list" class="file-list"></ul>
                <button type="submit" class="scan-button" id="scan-btn">scan</button>
                <p id="processing-message" style="display:none; font-size:20px;">
                    <i class="fa fa-spinner fa-spin"></i> Scanning for matches...
                </p>
            </form>

            <!-- Processed Output / Download Section (rendered when results exist) -->
            {% if summary_file and excerpt_file %}
            <div class="results" id="download-results">
                <h3>DOWNLOAD RESULTS</h3>
                <!-- Download buttons in a row -->
                <div class="download-buttons">
                    <a href="{{ url_for('download_file', filename=summary_file) }}" class="download-button">keyword match</a>
                    <a href="{{ url_for('download_file', filename=excerpt_file) }}" class="download-button">excerpts</a>
                </div>
                <!-- New Search button below the download buttons row -->
                <button type="button" class="clear-button" id="new-search-btn">new search</button>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // File Upload & Drag-and-Drop Handling
        const dropArea = document.getElementById("drop-area");
        const fileInput = document.getElementById("file-upload");
        const fileList = document.getElementById("file-list");
        const scanBtn = document.getElementById("scan-btn");
        let selectedFiles = [];  // Stores File objects

        // Prevent default behaviors for drag events
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ["dragenter", "dragover", "dragleave", "drop"].forEach(event => {
            dropArea.addEventListener(event, preventDefaults, false);
        });

        // Add visual feedback for dragging
        dropArea.addEventListener("dragover", () => dropArea.classList.add("dragover"));
        dropArea.addEventListener("dragleave", () => dropArea.classList.remove("dragover"));
        dropArea.addEventListener("drop", (e) => {
            dropArea.classList.remove("dragover");
            handleFiles(e.dataTransfer.files);
        });

        // Handle manual file selection
        fileInput.addEventListener("change", (e) => {
            handleFiles(e.target.files);
        });

        // Add new files, avoiding duplicates
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name)) {
                    selectedFiles.push(file);
                    updateFileList();
                }
            });
        }

        // Sync the file input using DataTransfer
        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
        }

        // Update the UI list of files and the file input
        function updateFileList() {
            fileList.innerHTML = "";
            selectedFiles.forEach((file, index) => {
                const li = document.createElement("li");
                li.innerHTML = `<span class="file-name">${file.name}</span>
                        <span class="delete-file" onclick="removeFile(${index})">
                          <i class="fa-solid fa-trash-can"></i>
                        </span>`;
                fileList.appendChild(li);
            });
            updateFileInput();
            scanBtn.disabled = selectedFiles.length === 0;
        }

        // Remove a file from selection
        function removeFile(index) {
            if (index >= 0 && index < selectedFiles.length) {
                selectedFiles.splice(index, 1);
                updateFileList();
            }
            if (selectedFiles.length === 0) {
                fileInput.value = "";
            }
        }

        // Show processing message and disable the scan button on submit
        document.getElementById("upload-form").addEventListener("submit", function () {
            scanBtn.disabled = true;
            document.getElementById("processing-message").style.display = "block";
        });

        // New Search button handler: reloads the page to clear processed results
        const newSearchBtn = document.getElementById("new-search-btn");
        if (newSearchBtn) {
            newSearchBtn.addEventListener("click", function () {
                window.location.href = "/";
            });
        }
    </script>
</body>

</html>