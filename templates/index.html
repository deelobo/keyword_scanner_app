<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title> Keyword Scanner App</title>

    <!-- Links to external stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">

</head>

<body>
    <div class="banner">keyword scanner</div>
    <div class="container">
        <h3>UPLOAD FILES</h3>

        <form action="/" method="post" enctype="multipart/form-data" id="upload-form">
            <label for="file-upload" class="upload-area" id="drop-area">
                <p>Drag & Drop files here or click to select</p>
                <input type="file" id="file-upload" name="files[]" multiple required>
            </label>
            <ul id="file-list" class="file-list"></ul>
            <button type="submit" class="scan-button" id="scan-btn">scan</button>
            <p id="processing-message" style="display:none;">Processing...</p>
        </form>

        {% if summary_file and excerpt_file %}
        <div class="results">
            <h3>DOWNLOAD RESULTS</h3>
            <a href="{{ url_for('download_file', filename='summary_results.xlsx') }}" class="download-button">Keyword
                Match</a>
            <a href="{{ url_for('download_file', filename='excerpt_results.xlsx') }}" class="download-button">
                Excerpts</a>
        </div>
        {% endif %}
    </div>

    <script>
        const dropArea = document.getElementById("drop-area");
        const fileInput = document.getElementById("file-upload");
        const fileList = document.getElementById("file-list");
        let selectedFiles = [];  // Store full file objects

        // Drag & Drop Events
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ["dragenter", "dragover", "dragleave", "drop"].forEach(event => {
            dropArea.addEventListener(event, preventDefaults, false);
        });
        dropArea.addEventListener("drop", (e) => {
            dropArea.classList.remove("dragover");
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener("change", (e) => {
            handleFiles(e.target.files);
        });

        // Handle Uploaded Files
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name)) {  // Prevent duplicates
                    selectedFiles.push(file);  // Store full file objects
                    updateFileList();
                }
            });
        }

        // Update the File List in UI
        function updateFileList() {
            fileList.innerHTML = "";  // Clear the list before re-rendering

            selectedFiles.forEach((file, index) => {
                let li = document.createElement("li");
                li.innerHTML = `<span class="file-name">${file.name}</span>
                                <span class="delete-file" onclick="removeFile(${index})">
                                    <i class="fa-solid fa-trash-can"></i>
                                </span>`;
                fileList.appendChild(li);
            });

            checkScanButton();  // Update button state
        }

        // Remove File from List
        function removeFile(index) {
            if (index >= 0 && index < selectedFiles.length) {
                selectedFiles.splice(index, 1);  // Remove file at the given index
                updateFileList();  // Refresh file list UI
            }

            // Reset file input if all files are deleted
            if (selectedFiles.length === 0) {
                document.getElementById("file-upload").value = "";
            }
        }

        // Disable Scan Button When No Files Are Selected
        function checkScanButton() {
            document.getElementById("scan-btn").disabled = selectedFiles.length === 0;
        }

        // Disable Button & Show "Processing..." on Form Submission
        document.getElementById("upload-form").addEventListener("submit", function () {
            document.getElementById("scan-btn").disabled = true;
            document.getElementById("processing-message").style.display = "block";
        });
    </script>
</body>

</html>